<!DOCTYPE html>
<html lang="en" data-theme="light">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>School Portal - Professional Sign In</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              primary: "#6366f1",
              secondary: "#4f46e5",
              accent: "#8b5cf6",
              success: "#10b981",
            },
          },
        },
      };
    </script>
    <style>
      @import url("https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap");

      * {
        font-family: "Inter", sans-serif;
      }

      /* CSS Variables for consistent theming - MATCHING DASHBOARD */
      :root {
        --primary-indigo: #6366f1;
        --secondary-purple: #4f46e5;
        --accent-purple: #8b5cf6;
        --success-green: #10b981;
        --error-red: #ef4444;
        --dark-text: #111827;
        --medium-text: #374151;
        --light-text: #6b7280;
        --white: #ffffff;

        /* Light mode colors (default) */
        --bg-primary: #f8fafc;
        --bg-secondary: #e0e7ff;
        --bg-tertiary: #f3e8ff;
        --card-bg: rgba(255, 255, 255, 0.8);
        --card-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        --navbar-bg: rgba(255, 255, 255, 0.8);
        --text-primary: #111827;
        --text-secondary: #374151;
        --text-muted: #6b7280;
        --border-color: rgba(0, 0, 0, 0.1);
        --skeleton-bg: rgba(0, 0, 0, 0.1);
      }

      /* Dark mode colors - MATCHING DASHBOARD */
      [data-theme="dark"] {
        --bg-primary: #0f172a;
        --bg-secondary: #1e293b;
        --bg-tertiary: #334155;
        --card-bg: rgba(30, 41, 59, 0.8);
        --card-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
        --navbar-bg: rgba(30, 41, 59, 0.8);
        --text-primary: #f8fafc;
        --text-secondary: #cbd5e1;
        --text-muted: #94a3b8;
        --border-color: rgba(255, 255, 255, 0.1);
        --skeleton-bg: rgba(255, 255, 255, 0.1);
      }

      body {
        background: linear-gradient(
          135deg,
          var(--bg-primary),
          var(--bg-secondary),
          var(--bg-tertiary)
        );
        color: var(--text-primary);
        transition: background 0.3s ease, color 0.3s ease;
      }

      .loading-spinner {
        border: 3px solid rgba(255, 255, 255, 0.3);
        border-top: 3px solid #ffffff;
        border-radius: 50%;
        width: 20px;
        height: 20px;
        animation: spin 1s linear infinite;
        display: inline-block;
        margin-left: 10px;
      }
      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }
      .feature-card {
        backdrop-filter: blur(10px);
        background: rgba(255, 255, 255, 0.1);
        transition: all 0.3s ease;
      }
      .feature-card:hover {
        background: rgba(255, 255, 255, 0.15);
        transform: translateX(5px);
      }
      input:focus::placeholder {
        opacity: 0.5;
      }
      .modern-input {
        transition: all 0.3s ease;
        border: 2px solid var(--border-color);
        background-color: var(--card-bg);
        color: var(--text-primary);
      }
      .modern-input:focus {
        border-color: #6366f1;
        box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        outline: none;
      }

      /* Theme Toggle Button */
      .theme-toggle {
        position: fixed;
        top: 20px;
        right: 20px;
        background: var(--card-bg);
        border: none;
        width: 50px;
        height: 50px;
        border-radius: 50%;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        z-index: 1000;
        transition: all 0.3s ease;
        backdrop-filter: blur(10px);
        color: var(--text-primary);
      }

      .theme-toggle:hover {
        transform: scale(1.1);
      }

      /* Main card styling */
      .main-card {
        background: var(--card-bg);
        backdrop-filter: blur(10px);
        border: 1px solid var(--border-color);
        transition: background 0.3s ease;
      }

      /* Toast Notification Styles */
      .toast-container {
        position: fixed;
        bottom: 2rem;
        left: 2rem;
        z-index: 9999;
        display: flex;
        flex-direction: column;
        gap: 1rem;
        max-width: 400px;
      }

      .toast {
        backdrop-filter: blur(16px);
        border-radius: 1rem;
        padding: 1.25rem 1.5rem;
        box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1),
          0 10px 10px -5px rgba(0, 0, 0, 0.04);
        display: flex;
        align-items: start;
        gap: 1rem;
        animation: slideIn 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
        border: 1px solid var(--border-color);
        min-width: 320px;
        background: var(--card-bg);
        color: var(--text-primary);
      }

      .toast.success {
        background: linear-gradient(
          135deg,
          rgba(16, 185, 129, 0.95) 0%,
          rgba(5, 150, 105, 0.95) 100%
        );
        color: white;
      }

      .toast.error {
        background: linear-gradient(
          135deg,
          rgba(239, 68, 68, 0.95) 0%,
          rgba(220, 38, 38, 0.95) 100%
        );
        color: white;
      }

      .toast.info {
        background: linear-gradient(
          135deg,
          rgba(99, 102, 241, 0.95) 0%,
          rgba(79, 70, 229, 0.95) 100%
        );
        color: white;
      }

      .toast-icon {
        flex-shrink: 0;
        width: 2.5rem;
        height: 2.5rem;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        background: rgba(255, 255, 255, 0.2);
        font-size: 1.25rem;
      }

      .toast-content {
        flex: 1;
        padding-top: 0.125rem;
      }

      .toast-title {
        font-weight: 600;
        font-size: 1rem;
        margin-bottom: 0.25rem;
      }

      .toast-message {
        font-size: 0.875rem;
        opacity: 0.95;
        line-height: 1.5;
      }

      .toast-close {
        flex-shrink: 0;
        background: rgba(255, 255, 255, 0.2);
        border: none;
        color: white;
        width: 1.75rem;
        height: 1.75rem;
        border-radius: 0.5rem;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s;
        font-size: 1rem;
      }

      .toast-close:hover {
        background: rgba(255, 255, 255, 0.3);
        transform: scale(1.1);
      }

      @keyframes slideIn {
        from {
          transform: translateX(-100%);
          opacity: 0;
        }
        to {
          transform: translateX(0);
          opacity: 1;
        }
      }

      .toast.hiding {
        animation: slideOut 0.3s ease forwards;
      }

      @keyframes slideOut {
        to {
          transform: translateX(-100%);
          opacity: 0;
        }
      }

      @media (max-width: 640px) {
        .toast-container {
          left: 1rem;
          right: 1rem;
          bottom: 1rem;
          max-width: none;
        }
        .toast {
          min-width: auto;
        }

        .theme-toggle {
          top: 15px;
          right: 15px;
          width: 45px;
          height: 45px;
        }
      }

      /* Custom text color classes using CSS variables */
      .text-primary-theme {
        color: var(--text-primary);
      }

      .text-secondary-theme {
        color: var(--text-secondary);
      }

      .text-muted-theme {
        color: var(--text-muted);
      }
    </style>
  </head>
  <body class="min-h-screen flex items-center justify-center p-4">
    <!-- Theme Toggle Button -->
    <button class="theme-toggle" id="themeToggle" title="Toggle theme">
      <i class="fas fa-moon" id="themeIcon"></i>
    </button>

    <!-- Toast Container -->
    <div id="toast-container" class="toast-container"></div>

    <div
      class="main-card rounded-3xl shadow-2xl overflow-hidden w-full max-w-5xl"
    >
      <div class="flex flex-col md:flex-row">
        <!-- Left Content (Info) -->
        <div
          class="md:w-2/5 p-10 bg-gradient-to-br from-indigo-600 via-purple-600 to-indigo-700 text-white relative overflow-hidden"
        >
          <!-- Decorative elements -->
          <div
            class="absolute top-0 right-0 w-64 h-64 bg-white/10 rounded-full -mr-32 -mt-32"
          ></div>
          <div
            class="absolute bottom-0 left-0 w-48 h-48 bg-white/10 rounded-full -ml-24 -mb-24"
          ></div>

          <div class="relative z-10">
            <div class="mb-10">
              <div class="flex items-center mb-4">
                <div
                  class="w-12 h-12 bg-white/20 backdrop-blur-sm rounded-xl flex items-center justify-center"
                >
                  <i class="fas fa-graduation-cap text-white text-2xl"></i>
                </div>
              </div>
              <h2 class="text-4xl font-bold mb-3 leading-tight">
                Welcome Back<br />to Your Portal
              </h2>
              <p class="text-indigo-100 text-sm leading-relaxed">
                Continue your educational journey with access to all your
                resources.
              </p>
            </div>

            <div class="space-y-5">
              <div class="feature-card p-4 rounded-xl">
                <div class="flex items-start">
                  <div class="bg-white/20 p-2.5 rounded-lg mr-3 flex-shrink-0">
                    <i class="fas fa-book-open text-white text-lg"></i>
                  </div>
                  <div>
                    <h3 class="font-semibold text-base mb-1">
                      Academic Resources
                    </h3>
                    <p class="text-indigo-100 text-xs leading-relaxed">
                      Access course materials, assignments, and real-time grade
                      tracking
                    </p>
                  </div>
                </div>
              </div>

              <div class="feature-card p-4 rounded-xl">
                <div class="flex items-start">
                  <div class="bg-white/20 p-2.5 rounded-lg mr-3 flex-shrink-0">
                    <i class="fas fa-users text-white text-lg"></i>
                  </div>
                  <div>
                    <h3 class="font-semibold text-base mb-1">
                      Collaborative Learning
                    </h3>
                    <p class="text-indigo-100 text-xs leading-relaxed">
                      Connect with classmates, join study groups, and
                      collaborate on projects
                    </p>
                  </div>
                </div>
              </div>

              <div class="feature-card p-4 rounded-xl">
                <div class="flex items-start">
                  <div class="bg-white/20 p-2.5 rounded-lg mr-3 flex-shrink-0">
                    <i class="fas fa-shield-alt text-white text-lg"></i>
                  </div>
                  <div>
                    <h3 class="font-semibold text-base mb-1">
                      Secure & Private
                    </h3>
                    <p class="text-indigo-100 text-xs leading-relaxed">
                      Your data is encrypted and protected with enterprise-grade
                      security protocols
                    </p>
                  </div>
                </div>
              </div>
            </div>

            <div class="mt-10 pt-6 border-t border-white/20">
              <p class="text-indigo-100 text-sm mb-3">
                Don't have an account yet?
              </p>
              <a
                href="signup.html"
                class="inline-flex items-center justify-center w-full bg-white/10 backdrop-blur-sm hover:bg-white/20 text-white px-4 py-3 rounded-xl font-medium transition-all duration-300 border border-white/30"
              >
                <i class="fas fa-user-plus mr-2"></i> Create Account
              </a>
            </div>
          </div>
        </div>

        <!-- Right Content (Form) -->
        <div class="md:w-3/5 p-10">
          <div class="mb-8">
            <!-- UPDATED: Using CSS variables for text colors -->
            <h2 class="text-3xl font-bold text-primary-theme mb-2">Sign In</h2>
            <p class="text-muted-theme text-sm">
              Access your educational resources and continue learning
            </p>
          </div>

          <!-- Sign In Form -->
          <form id="signin-form">
            <div class="space-y-6">
              <div>
                <label
                  class="block text-sm font-semibold text-secondary-theme mb-2"
                  for="email-username"
                  >Email or Username <span class="text-red-500">*</span></label
                >
                <input
                  type="text"
                  id="email-username"
                  required
                  class="modern-input w-full px-4 py-3 rounded-xl"
                  placeholder="student@school.edu or johndoe123"
                />
              </div>

              <div>
                <label
                  class="block text-sm font-semibold text-secondary-theme mb-2"
                  for="password"
                  >Password <span class="text-red-500">*</span></label
                >
                <input
                  type="password"
                  id="password"
                  required
                  class="modern-input w-full px-4 py-3 rounded-xl"
                  placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢"
                />
                <div class="flex justify-end mt-2">
                  <a
                    href="/forgot-password"
                    class="text-sm text-primary hover:underline"
                    >Forgot Password?</a
                  >
                </div>
              </div>

              <div class="flex items-start">
                <input
                  type="checkbox"
                  id="remember-me"
                  class="mt-1 mr-3 rounded border-gray-300 text-primary focus:ring-primary dark:border-gray-600 dark:bg-gray-700"
                  checked
                />
                <label for="remember-me" class="text-sm text-secondary-theme"
                  >Remember me on this device</label
                >
              </div>

              <button
                type="submit"
                id="submit-btn"
                class="w-full bg-gradient-to-r from-indigo-600 to-purple-600 text-white px-6 py-3.5 rounded-xl font-semibold hover:shadow-lg hover:scale-[1.02] transition-all duration-300 flex items-center justify-center"
              >
                <span id="submit-btn-text">Sign In</span>
                <div id="submit-loading" class="loading-spinner hidden"></div>
              </button>
            </div>
          </form>

          <!-- Social signin section -->
          <div class="mt-8 pt-6 border-t border-gray-200 dark:border-gray-700">
            <p class="text-center text-muted-theme text-sm mb-4">
              Or sign in with
            </p>
            <div class="flex justify-center space-x-4">
              <button
                onclick="handleGoogleSignIn()"
                class="bg-gray-100 p-3 rounded-xl hover:bg-gray-200 transition-all duration-300 flex items-center justify-center w-12 h-12 cursor-pointer dark:bg-gray-700 dark:hover:bg-gray-600"
              >
                <i class="fab fa-google text-red-500 text-lg"></i>
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      // Theme Management - MATCHING DASHBOARD
      const themeToggle = document.getElementById("themeToggle");
      const themeIcon = document.getElementById("themeIcon");
      const htmlElement = document.documentElement;

      // Function to set theme
      function setTheme(theme) {
        htmlElement.setAttribute("data-theme", theme);
        localStorage.setItem("theme", theme);

        // Update icon
        if (theme === "dark") {
          themeIcon.className = "fas fa-sun";
        } else {
          themeIcon.className = "fas fa-moon";
        }
      }

      // Function to toggle theme
      function toggleTheme() {
        const currentTheme = htmlElement.getAttribute("data-theme");
        const newTheme = currentTheme === "dark" ? "light" : "dark";
        setTheme(newTheme);
      }

      // Initialize theme
      function initTheme() {
        // Check for saved theme preference
        const savedTheme = localStorage.getItem("theme");

        if (savedTheme) {
          setTheme(savedTheme);
        } else {
          // Check system preference
          const prefersDark = window.matchMedia(
            "(prefers-color-scheme: dark)"
          ).matches;
          setTheme(prefersDark ? "dark" : "light");
        }
      }

      // Listen for system theme changes
      window
        .matchMedia("(prefers-color-scheme: dark)")
        .addEventListener("change", (e) => {
          // Only change if user hasn't set a preference
          if (!localStorage.getItem("theme")) {
            setTheme(e.matches ? "dark" : "light");
          }
        });

      // âš™ï¸ API Configuration - Dynamic URL for localhost and Render
      const getApiBaseUrl = () => {
        // Check if we're on localhost
        if (
          window.location.hostname === "localhost" ||
          window.location.hostname === "127.0.0.1"
        ) {
          return "http://localhost:8000";
        }
        // For production (Render), use relative path (same domain)
        return "";
      };

      const API_BASE_URL = getApiBaseUrl();

      // Override default alert with toast
      window.alert = function (message) {
        showToast(message, "info", "Notice");
      };

      // Toast Notification System
      function showToast(message, type = "info", title = "", duration = 5000) {
        const container = document.getElementById("toast-container");

        // Set default titles based on type
        if (!title) {
          switch (type) {
            case "success":
              title = "Success!";
              break;
            case "error":
              title = "Error";
              break;
            case "info":
              title = "Information";
              break;
          }
        }

        // Get appropriate icon
        let icon;
        switch (type) {
          case "success":
            icon = '<i class="fas fa-check-circle"></i>';
            break;
          case "error":
            icon = '<i class="fas fa-exclamation-circle"></i>';
            break;
          case "info":
            icon = '<i class="fas fa-info-circle"></i>';
            break;
          default:
            icon = '<i class="fas fa-bell"></i>';
        }

        // Create toast element
        const toast = document.createElement("div");
        toast.className = `toast ${type}`;
        toast.innerHTML = `
      <div class="toast-icon">${icon}</div>
      <div class="toast-content">
        <div class="toast-title">${title}</div>
        <div class="toast-message">${message}</div>
      </div>
      <button class="toast-close" onclick="this.parentElement.remove()">
        <i class="fas fa-times"></i>
      </button>
    `;

        container.appendChild(toast);

        // Auto remove after duration
        setTimeout(() => {
          toast.classList.add("hiding");
          setTimeout(() => toast.remove(), 300);
        }, duration);
      }

      // Authentication state management
      async function checkAuthState() {
        const token = localStorage.getItem("access_token");
        const userData = localStorage.getItem("user");

        if (!token || !userData) {
          console.log("ðŸ” No authentication data found");
          return null;
        }

        try {
          // Verify token is still valid with backend
          const response = await fetch(`${API_BASE_URL}/auth/me`, {
            headers: {
              Authorization: `Bearer ${token}`,
            },
          });

          if (response.ok) {
            const user = JSON.parse(userData);
            console.log("âœ… User is authenticated:", user.email);
            return user;
          } else {
            // Token is invalid, clear storage
            console.log("âŒ Token invalid, clearing storage");
            clearAuthData();
            return null;
          }
        } catch (error) {
          console.error("âŒ Auth check failed:", error);
          // If backend check fails, still try to use stored data
          try {
            return JSON.parse(userData);
          } catch {
            clearAuthData();
            return null;
          }
        }
      }

      function clearAuthData() {
        localStorage.removeItem("access_token");
        localStorage.removeItem("token_type");
        localStorage.removeItem("user");
        localStorage.removeItem("auth_error");
        localStorage.removeItem("success_message");
      }

      // Redirect authenticated users away from auth pages
      async function redirectIfAuthenticated() {
        const user = await checkAuthState();

        if (user) {
          console.log(
            "ðŸ”„ User is already authenticated, redirecting to dashboard..."
          );

          // If we're on a sign-in/sign-up page, redirect to dashboard
          if (
            window.location.pathname.includes("signin.html") ||
            window.location.pathname.includes("signup.html")
          ) {
            let dashboardUrl;
            if (user.role === "admin") {
              dashboardUrl = "/static/dashboards/Admin-Dashboard-Overview.html";
            } else {
              dashboardUrl =
                "/static/dashboards/student-dashboard-overview.html";
            }

            // Add a small delay to show any success messages
            setTimeout(() => {
              window.location.href = dashboardUrl;
            }, 500);
          }
        }
      }

      function showLoadingState(show) {
        const submitBtn = document.getElementById("submit-btn");
        const submitBtnText = document.getElementById("submit-btn-text");
        const submitLoading = document.getElementById("submit-loading");

        if (submitBtn && submitBtnText && submitLoading) {
          submitBtn.disabled = show;
          submitBtnText.textContent = show ? "Signing In..." : "Sign In";
          submitLoading.classList.toggle("hidden", !show);
        }
      }

      function redirectToDashboard(user) {
        let dashboardUrl;
        if (user.role === "admin") {
          dashboardUrl = "/static/dashboards/Admin-Dashboard-Overview.html";
        } else {
          dashboardUrl = "/static/dashboards/student-dashboard-overview.html";
        }
        console.log("ðŸ”„ Redirecting to:", dashboardUrl);
        window.location.href = dashboardUrl;
      }

      function cleanUrl() {
        window.history.replaceState(
          {},
          document.title,
          window.location.pathname
        );
      }

      // Form validation helpers
      function validateForm() {
        let isValid = true;

        const emailUsername = document.getElementById("email-username").value;
        const password = document.getElementById("password").value;

        if (!emailUsername.trim()) {
          showError("email-username", "Email or username is required");
          isValid = false;
        } else {
          clearError("email-username");
        }

        if (!password) {
          showError("password", "Password is required");
          isValid = false;
        } else {
          clearError("password");
        }

        return isValid;
      }

      function showError(fieldId, message) {
        const field = document.getElementById(fieldId);
        field.style.borderColor = "#ef4444";

        // Remove any existing error message
        let existingError = field.parentNode.querySelector(".error-message");
        if (existingError) {
          existingError.remove();
        }

        // Add error message
        const errorElement = document.createElement("p");
        errorElement.className = "error-message text-red-500 text-xs mt-1";
        errorElement.textContent = message;
        field.parentNode.appendChild(errorElement);

        // Remove error styling on input
        field.addEventListener(
          "input",
          function () {
            field.style.borderColor = "var(--border-color)";
            const errorMsg = field.parentNode.querySelector(".error-message");
            if (errorMsg) {
              errorMsg.remove();
            }
          },
          { once: true }
        );
      }

      function clearError(fieldId) {
        const field = document.getElementById(fieldId);
        field.style.borderColor = "var(--border-color)";

        // Remove error message
        const errorElement = field.parentNode.querySelector(".error-message");
        if (errorElement) {
          errorElement.remove();
        }
      }

      // Google Sign-In handler
      async function handleGoogleSignIn() {
        try {
          console.log("ðŸ” Starting Google Sign-In...");

          // Get Google OAuth URL for signin
          const response = await fetch(`${API_BASE_URL}/auth/google/url`);
          const data = await response.json();

          if (!response.ok) {
            throw new Error("Failed to get Google auth URL");
          }

          console.log("ðŸ”„ Redirecting to Google OAuth for sign-in...");
          window.location.href = data.auth_url;
        } catch (error) {
          console.error("âŒ Google Sign-In error:", error);
          showToast(
            "Failed to start Google Sign-In. Please try again.",
            "error",
            "Google Sign-In Failed"
          );
        }
      }

      // Enhanced Google callback handler
      async function handleGoogleCallback() {
        const urlParams = new URLSearchParams(window.location.search);
        const code = urlParams.get("code");
        const error = urlParams.get("error");

        console.log("ðŸ”„ Checking Google callback...");

        // Handle errors first
        if (error) {
          console.error("âŒ Google OAuth error:", error);
          showToast(
            decodeURIComponent(error),
            "error",
            "Google Sign-In Failed"
          );
          cleanUrl();
          return;
        }

        if (code) {
          console.log("ðŸ”„ Handling Google OAuth callback...");

          try {
            showLoadingState(true);

            const response = await fetch(`${API_BASE_URL}/auth/google`, {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({ code: code }),
            });

            console.log("ðŸ“¨ Backend response status:", response.status);

            if (!response.ok) {
              const errorData = await response.json();
              throw new Error(
                errorData.detail || `HTTP error! status: ${response.status}`
              );
            }

            const data = await response.json();

            if (data.access_token && data.user) {
              // Store authentication data
              localStorage.setItem("access_token", data.access_token);
              localStorage.setItem("token_type", data.token_type);
              localStorage.setItem("user", JSON.stringify(data.user));

              console.log("âœ… Google authentication successful");

              // Show success message
              showToast(
                `Welcome, ${data.user.full_name || data.user.username}!`,
                "success",
                "Google Sign-In Successful!",
                3000
              );

              cleanUrl();

              // Redirect to dashboard after successful auth
              setTimeout(() => {
                redirectToDashboard(data.user);
              }, 1000);
            }
          } catch (error) {
            console.error("âŒ Google callback error:", error);
            showToast(
              error.message ||
                "Google authentication failed. Please try again.",
              "error",
              "Authentication Failed"
            );
            cleanUrl();
          } finally {
            showLoadingState(false);
          }
        } else {
          // No callback code, check if user is already authenticated
          await redirectIfAuthenticated();
        }
      }

      // Check for authentication errors on page load
      function checkAuthErrors() {
        const authError = localStorage.getItem("auth_error");
        if (authError) {
          showToast(authError, "error", "Authentication Failed");
          localStorage.removeItem("auth_error");
        }

        // Also check for success messages
        const successMessage = localStorage.getItem("success_message");
        if (successMessage) {
          showToast(successMessage, "success", "Success!");
          localStorage.removeItem("success_message");
        }
      }

      // Main initialization
      document.addEventListener("DOMContentLoaded", function () {
        console.log("ðŸš€ Page loaded - Initializing authentication...");
        console.log("ðŸ“ Current environment:", window.location.hostname);
        console.log("ðŸŒ API_BASE_URL:", API_BASE_URL);

        // Initialize theme first
        initTheme();

        // Set up theme toggle
        themeToggle.addEventListener("click", toggleTheme);

        // Check for authentication errors
        checkAuthErrors();

        // Check Google callback and auth state
        handleGoogleCallback();

        // Form submission
        document
          .getElementById("signin-form")
          .addEventListener("submit", async function (e) {
            e.preventDefault();

            if (validateForm()) {
              showLoadingState(true);

              try {
                const identifier = document
                  .getElementById("email-username")
                  .value.trim();
                const password = document.getElementById("password").value;

                console.log("ðŸ” Login attempt with identifier:", identifier);

                // Prepare form data for OAuth2PasswordRequestForm
                const formData = new URLSearchParams();
                formData.append("username", identifier);
                formData.append("password", password);

                console.log(
                  "ðŸ“¡ Sending login request to:",
                  `${API_BASE_URL}/users/login`
                );

                // Send login request to backend
                const response = await fetch(`${API_BASE_URL}/users/login`, {
                  method: "POST",
                  headers: {
                    "Content-Type": "application/x-www-form-urlencoded",
                  },
                  body: formData,
                });

                console.log("ðŸ“¨ Response status:", response.status);

                let data;
                try {
                  data = await response.json();
                  console.log("ðŸ“Š Response data:", data);
                } catch (jsonError) {
                  console.error("âŒ JSON parse error:", jsonError);
                  throw new Error("Invalid server response");
                }

                if (response.ok) {
                  // Success! Store the token and user data
                  localStorage.setItem("access_token", data.access_token);
                  localStorage.setItem("token_type", data.token_type);
                  localStorage.setItem("user", JSON.stringify(data.user));

                  console.log("âœ… Login successful, user data:", data.user);

                  // Show success message with toast
                  showToast(
                    `Welcome back, ${
                      data.user.username || data.user.email
                    }! Redirecting...`,
                    "success",
                    "Login Successful!",
                    3000
                  );

                  // Redirect to dashboard based on role after a short delay
                  setTimeout(() => {
                    redirectToDashboard(data.user);
                  }, 1500);
                } else {
                  // Error from server - handle specific error messages
                  const errorMessage = data.detail || "Login failed";
                  console.error("âŒ Login error:", errorMessage);

                  // More user-friendly error messages
                  let userFriendlyMessage = errorMessage;
                  if (errorMessage.includes("User not found")) {
                    userFriendlyMessage =
                      "No account found with this email/username. Please check your credentials or sign up.";
                  } else if (errorMessage.includes("Invalid password")) {
                    userFriendlyMessage =
                      "Incorrect password. Please try again.";
                  } else if (errorMessage.includes("deactivated")) {
                    userFriendlyMessage =
                      "Your account has been deactivated. Please contact support.";
                  }

                  throw new Error(userFriendlyMessage);
                }
              } catch (error) {
                console.error("ðŸ’¥ Login error:", error);

                // Handle connection errors specifically
                let userMessage = error.message;
                if (
                  error.name === "TypeError" &&
                  error.message.includes("Failed to fetch")
                ) {
                  userMessage =
                    "Cannot connect to the server. Please check your internet connection.";
                }

                showToast(userMessage, "error", "Login Failed");
              } finally {
                showLoadingState(false);
              }
            }
          });

        // Welcome message
        setTimeout(() => {
          showToast(
            "Enter your email/username and password to access your account",
            "info",
            "Ready to Sign In",
            4000
          );
        }, 1000);
      });
    </script>
  </body>
</html>
